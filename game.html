<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MYSTCL INVADERS</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, 
                #0a0a23 0%, 
                #1a1a3a 25%, 
                #2a2a4a 50%, 
                #1a1a3a 75%, 
                #0a0a23 100%);
            background-size: 400% 400%;
            animation: cosmicShift 8s ease infinite;
            min-height: 100vh;
            min-height: 100dvh;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            position: relative;
            width: 100%;
            height: 100%;
        }

        @keyframes cosmicShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite alternate;
        }

        @keyframes twinkle {
            0% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        /* Welcome Page Styles */
        .welcome-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            z-index: 10;
            position: relative;
        }

        .welcome-card {
            background: linear-gradient(145deg, 
                rgba(0, 20, 40, 0.95) 0%, 
                rgba(20, 40, 60, 0.9) 25%, 
                rgba(10, 30, 50, 0.95) 50%, 
                rgba(20, 40, 60, 0.9) 75%, 
                rgba(0, 20, 40, 0.95) 100%);
            border: 3px solid #00ffff;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            text-align: center;
            box-shadow: 
                0 0 30px rgba(0, 255, 255, 0.3),
                0 0 60px rgba(255, 0, 255, 0.2),
                inset 0 0 20px rgba(0, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            animation: cardGlow 4s ease-in-out infinite alternate;
        }

        @keyframes cardGlow {
            0% { box-shadow: 0 0 30px rgba(0, 255, 255, 0.3), 0 0 60px rgba(255, 0, 255, 0.2), inset 0 0 20px rgba(0, 255, 255, 0.1); }
            100% { box-shadow: 0 0 40px rgba(0, 255, 255, 0.5), 0 0 80px rgba(255, 0, 255, 0.3), inset 0 0 30px rgba(0, 255, 255, 0.2); }
        }

        .title {
            font-size: 48px;
            font-weight: bold;
            background: linear-gradient(45deg, #ff00ff, #00ffff, #ffff00, #ff00ff);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 0, 255, 0.8);
            margin-bottom: 10px;
            letter-spacing: 4px;
            animation: titleShimmer 3s ease-in-out infinite;
        }

        @keyframes titleShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle {
            font-size: 20px;
            color: #00ffff;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
            margin-bottom: 30px;
            letter-spacing: 2px;
        }

        .description {
            font-size: 16px;
            color: #ffffff;
            line-height: 1.6;
            margin-bottom: 40px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .play-button {
            background: linear-gradient(45deg, #ff00ff, #00ffff, #ff00ff);
            background-size: 200% 200%;
            border: 3px solid #ffffff;
            border-radius: 15px;
            padding: 15px 40px;
            font-size: 24px;
            font-weight: bold;
            color: #000000;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            box-shadow: 
                0 0 20px rgba(255, 0, 255, 0.6),
                0 0 40px rgba(0, 255, 255, 0.4);
            transition: all 0.3s ease;
            animation: buttonPulse 2s ease-in-out infinite alternate;
        }

        @keyframes buttonPulse {
            0% { 
                background-position: 0% 50%;
                transform: scale(1);
            }
            100% { 
                background-position: 100% 50%;
                transform: scale(1.05);
            }
        }

        .play-button:hover {
            transform: scale(1.1);
            box-shadow: 
                0 0 30px rgba(255, 0, 255, 0.8),
                0 0 60px rgba(0, 255, 255, 0.6);
            background: linear-gradient(45deg, #ff44ff, #44ffff, #ff44ff);
        }

        .play-button:active {
            transform: scale(0.95);
        }

        .info-box {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #ffff00;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            color: #ffff00;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.8);
        }

        .info-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #00ff00;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
        }

        .info-item {
            margin: 8px 0;
            font-size: 14px;
        }

        .floating-mystcl {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 60px;
            color: #ff00ff;
            text-shadow: 0 0 20px rgba(255, 0, 255, 0.8);
            animation: float 6s ease-in-out infinite;
            z-index: 5;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-10px) rotate(2deg); }
            66% { transform: translateY(5px) rotate(-1deg); }
        }

        /* Game Styles */
        .game-screen {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: linear-gradient(180deg, #0a0a23 0%, #1a1a3a 50%, #2a2a4a 100%);
            overflow: hidden;
        }

        @media (min-width: 769px) {
            .game-container {
                width: 800px;
                height: 600px;
                max-width: 95vw;
                max-height: 80vh;
                border: 3px solid #00ffff;
                border-radius: 10px;
                box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            }
        }

        @media (max-width: 768px) {
            .game-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                height: 100dvh;
                border: none;
                border-radius: 0;
            }
            
            html, body {
                overflow: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
            }
        }

        canvas {
            display: block;
            background: transparent;
        }

        .ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #00ffff;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
            z-index: 10;
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #ff00ff;
            border-radius: 15px;
            padding: 30px;
            color: #ff00ff;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            text-shadow: 0 0 20px rgba(255, 0, 255, 0.8);
            z-index: 20;
            display: none;
            min-width: 300px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
        }

        .game-over h2 {
            margin: 0 0 20px 0;
            font-size: 36px;
            color: #ff00ff;
        }

        .leaderboard-popup {
            margin: 20px 0;
            color: #00ffff;
            font-size: 16px;
        }

        .leaderboard-popup h3 {
            margin: 10px 0;
            font-size: 20px;
            color: #ffff00;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px 10px;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 5px;
        }

        .controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #00ffff;
            font-size: 12px;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.8);
            z-index: 10;
        }

        .leaderboard {
            display: none;
        }

        .name-input {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border: 2px solid #00ffff;
            border-radius: 10px;
            color: #00ffff;
            text-align: center;
            z-index: 30;
            display: none;
            max-width: 90vw;
        }

        .name-input input {
            background: rgba(0, 50, 50, 0.8);
            border: 1px solid #00ffff;
            color: #00ffff;
            padding: 8px;
            margin: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }

        .name-input button, .restart-btn {
            background: #ff00ff;
            border: none;
            color: white;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
        }

        .restart-btn {
            background: #ffff00;
            color: #000000;
            padding: 10px 20px;
            margin-top: 15px;
        }

        .restart-btn:active {
            background: #cccc00;
            transform: scale(0.95);
        }

        .game-title {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            color: #ff00ff;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255, 0, 255, 0.8);
            letter-spacing: 3px;
        }

        @media (max-width: 768px) {
            .game-title {
                display: none;
            }
        }

        /* Mobile Controls */
        .mobile-controls {
            position: fixed;
            bottom: 30px;
            left: 0;
            right: 0;
            width: 100%;
            height: 100px;
            display: none;
            z-index: 100;
        }

        .joystick-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 80px;
        }

        .joystick-track {
            position: absolute;
            top: 50%;
            left: 0;
            width: 200px;
            height: 2px;
            background: rgba(0, 255, 255, 0.3);
            transform: translateY(-50%);
        }

        .joystick-stick {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: #00ffff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
            cursor: pointer;
            touch-action: none;
        }

        .fire-button {
            position: absolute;
            bottom: 20px;
            right: 30px;
            width: 70px;
            height: 70px;
            background: rgba(255, 0, 255, 0.3);
            border: 3px solid #ff00ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #ff00ff;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.6);
            cursor: pointer;
            touch-action: none;
        }

        .fire-button:active {
            background: rgba(255, 0, 255, 0.6);
            transform: scale(0.9);
        }

        /* Only show mobile controls on actual mobile devices */
        @media (max-width: 768px) and (pointer: coarse) {
            .mobile-controls {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    <div class="floating-mystcl">👾</div>
    
    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-card">
            <h1 class="title">MYSTCL INVADERS</h1>
            <div class="subtitle">MYSTCL ARCADE</div>
            
            <p class="description">
                Navigate the cosmic battlefield as a mystical being! Defend against waves of alien invaders 
                while hiding behind destructible MYSTCL shields. Use your ethereal powers to shoot energy blasts 
                and survive the interdimensional invasion!
            </p>
            
            <button class="play-button" onclick="startGame()">
                ⚡ LAUNCH GAME ⚡
            </button>
            
            <div class="info-box">
                <div class="info-title">🎮 Game Controls:</div>
                <div class="info-item"><strong>ARROWS:</strong> Move your mystical being left and right</div>
                <div class="info-item"><strong>SPACEBAR:</strong> Fire energy blasts at invaders</div>
                <div class="info-item"><strong>GOAL:</strong> Survive waves and protect the MYSTCL shields!</div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div class="game-screen" id="gameScreen">
        <div class="game-container">
            <div class="game-title">MYSTCL INVADERS</div>
            <canvas id="gameCanvas"></canvas>
            <div class="ui">
                <div>Score: <span id="score">0</span></div>
                <div>Lives: <span id="lives">3</span></div>
                <div>Level: <span id="level">1</span></div>
            </div>
            <div class="leaderboard">
                <h3>Leaderboard</h3>
                <div id="leaderboardList"></div>
            </div>
            <div class="game-over" id="gameOver">
                <h2>GAME OVER</h2>
                <div>Final Score: <span id="finalScore">0</span></div>
                <div class="leaderboard-popup">
                    <h3>🏆 LEADERBOARD 🏆</h3>
                    <div id="gameOverLeaderboard"></div>
                </div>
                <button class="restart-btn" onclick="resetGame()">RESTART GAME</button>
            </div>
            <div class="name-input" id="nameInput">
                <div>Enter Your Name</div>
                <input type="text" id="playerName" maxlength="10" placeholder="Player">
                <br>
                <button onclick="submitScore()">Submit Score</button>
                <button onclick="skipScore()">Skip</button>
            </div>
            <div class="controls">
                <span id="desktopControls">Arrow Keys: Move | Space: Shoot | R: Restart</span>
                <span id="mobileControls" style="display: none;">Use slider to move | Tap FIRE to shoot</span>
            </div>
            
            <!-- Mobile Controls -->
            <div class="mobile-controls" id="mobileControlsUI">
                <div class="joystick-container" id="joystick">
                    <div class="joystick-track">
                        <div class="joystick-stick" id="joystickStick"></div>
                    </div>
                </div>
                <div class="fire-button" id="fireButton">FIRE</div>
            </div>
        </div>
    </div>

    <script>
        // Create animated stars background
        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = star.style.height = Math.random() * 4 + 1 + 'px';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (Math.random() * 3 + 2) + 's';
                starsContainer.appendChild(star);
            }
        }

        function startGame() {
            // Add click effect
            document.querySelector('.play-button').style.transform = 'scale(0.9)';
            setTimeout(() => {
                // Hide welcome screen and show game
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('gameScreen').style.display = 'flex';
                
                // Initialize game
                initializeGame();
            }, 150);
        }

        // Initialize effects
        createStars();

        // Add some dynamic effects for welcome screen
        document.addEventListener('mousemove', (e) => {
            const card = document.querySelector('.welcome-card');
            if (!card || !document.getElementById('welcomeScreen').style.display !== 'none') return;
            
            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            const rotateX = (y - centerY) / 20;
            const rotateY = (centerX - x) / 20;
            
            card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        });

        document.addEventListener('mouseleave', () => {
            const card = document.querySelector('.welcome-card');
            if (card) {
                card.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg)';
            }
        });

        // GAME CODE STARTS HERE
        let gameInitialized = false;

        function initializeGame() {
            if (gameInitialized) return;
            gameInitialized = true;

            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');

            // Responsive canvas sizing
            function resizeCanvas() {
                const container = document.querySelector('.game-container');
                const containerRect = container.getBoundingClientRect();
                
                canvas.width = containerRect.width;
                canvas.height = containerRect.height;
                
                // Update game boundaries
                gameState.canvasWidth = canvas.width;
                gameState.canvasHeight = canvas.height;
                
                // Adjust player position if out of bounds
                if (player.x > canvas.width - player.width) {
                    player.x = canvas.width - player.width;
                }
            }

            // Detect mobile device
            function isMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                       ('ontouchstart' in window) || 
                       (navigator.maxTouchPoints > 0);
            }

            // Game state
            let gameState = {
                score: 0,
                lives: 3,
                level: 1,
                gameOver: false,
                keys: {},
                lastShot: 0,
                invaderSpeed: 0.5,
                shieldScale: 1.0,
                canvasWidth: 800,
                canvasHeight: 600,
                scaleFactor: 1
            };

            // Leaderboard storage
            let leaderboard = [];
            try {
                const stored = localStorage.getItem('mystclInvadersLeaderboard');
                if (stored) leaderboard = JSON.parse(stored);
            } catch (e) {
                leaderboard = [];
            }

            // Player ship
            const player = {
                x: 375,
                y: 550,
                width: 50,
                height: 40,
                speed: 5,
                color: '#00ff88'
            };

            // Scale player position for different screen sizes
            function scalePlayerPosition() {
                player.x = gameState.canvasWidth * 0.46875;
                // Adjust Y position to account for mobile controls
                if (isMobile()) {
                    player.y = gameState.canvasHeight * 0.75; // Higher up to avoid controls
                } else {
                    player.y = gameState.canvasHeight * 0.91667; // Original position
                }
            }

            // Arrays for game objects
            let bullets = [];
            let invaders = [];
            let invaderBullets = [];
            let particles = [];
            let shields = [];

            // MYSTCL Shield patterns
            const shieldPatterns = {
                'M': [
                    [1,1,0,0,0,1,1],
                    [1,1,1,0,1,1,1],
                    [1,1,0,1,0,1,1],
                    [1,1,0,1,0,1,1],
                    [1,1,0,0,0,1,1],
                    [1,1,0,0,0,1,1],
                    [1,1,0,0,0,1,1],
                    [1,1,0,0,0,1,1]
                ],
                'Y': [
                    [1,1,0,0,0,1,1],
                    [1,1,0,0,0,1,1],
                    [0,1,1,0,1,1,0],
                    [0,0,1,1,1,0,0],
                    [0,0,1,1,1,0,0],
                    [0,0,1,1,1,0,0],
                    [0,0,1,1,1,0,0],
                    [0,0,1,1,1,0,0]
                ],
                'S': [
                    [0,1,1,1,1,1,0],
                    [1,1,0,0,0,1,1],
                    [1,1,0,0,0,0,0],
                    [0,1,1,1,1,0,0],
                    [0,0,0,1,1,1,0],
                    [0,0,0,0,1,1,1],
                    [1,1,0,0,1,1,1],
                    [0,1,1,1,1,1,0]
                ],
                'T': [
                    [1,1,1,1,1,1,1],
                    [1,1,1,1,1,1,1],
                    [0,0,1,1,1,0,0],
                    [0,0,1,1,1,0,0],
                    [0,0,1,1,1,0,0],
                    [0,0,1,1,1,0,0],
                    [0,0,1,1,1,0,0],
                    [0,0,1,1,1,0,0]
                ],
                'C': [
                    [0,1,1,1,1,1,0],
                    [1,1,0,0,0,1,1],
                    [1,1,0,0,0,0,0],
                    [1,1,0,0,0,0,0],
                    [1,1,0,0,0,0,0],
                    [1,1,0,0,0,0,0],
                    [1,1,0,0,0,1,1],
                    [0,1,1,1,1,1,0]
                ],
                'L': [
                    [1,1,0,0,0,0,0],
                    [1,1,0,0,0,0,0],
                    [1,1,0,0,0,0,0],
                    [1,1,0,0,0,0,0],
                    [1,1,0,0,0,0,0],
                    [1,1,0,0,0,0,0],
                    [1,1,1,1,1,1,1],
                    [1,1,1,1,1,1,1]
                ]
            };

            // Pixel art style drawing functions
            function drawPixelRect(x, y, width, height, color) {
                ctx.fillStyle = color;
                ctx.fillRect(Math.floor(x), Math.floor(y), width, height);
            }

            function createShields() {
                shields = [];
                const letters = ['M', 'Y', 'S', 'T', 'C', 'L'];
                const shieldColors = ['#ff00ff', '#ffff00', '#00ffff', '#ff6600', '#00ff00', '#ff0066'];
                const startX = gameState.canvasWidth * 0.0875;
                const spacing = gameState.canvasWidth * 0.1375;
                const baseBlockSize = gameState.canvasWidth * 0.0075;
                const blockSize = Math.max(2, Math.floor(baseBlockSize * gameState.shieldScale));
                
                letters.forEach((letter, letterIndex) => {
                    const pattern = shieldPatterns[letter];
                    const letterX = startX + letterIndex * spacing;
                    // Adjust shield Y position to account for mobile controls
                    let letterY;
                    if (isMobile()) {
                        letterY = gameState.canvasHeight * 0.55; // Higher up to avoid controls
                    } else {
                        letterY = gameState.canvasHeight * 0.71667; // Original position
                    }
                    
                    pattern.forEach((row, rowIndex) => {
                        row.forEach((pixel, colIndex) => {
                            if (pixel === 1) {
                                shields.push({
                                    x: letterX + colIndex * blockSize,
                                    y: letterY + rowIndex * blockSize,
                                    width: blockSize,
                                    height: blockSize,
                                    color: shieldColors[letterIndex],
                                    alive: true,
                                    letter: letter
                                });
                            }
                        });
                    });
                });
            }

            function drawShields() {
                shields.forEach(block => {
                    if (block.alive) {
                        // Add glow effect to shields
                        ctx.shadowColor = block.color;
                        ctx.shadowBlur = 5;
                        drawPixelRect(block.x, block.y, block.width, block.height, block.color);
                        ctx.shadowBlur = 0;
                    }
                });
            }

            function drawPlayer() {
                // Player - clean circular head with HUGE vibrant glasses and elf ears
                const headRadius = 18;
                const centerX = player.x + player.width/2;
                const centerY = player.y + player.height/2;
                
                // Draw smooth circular head
                drawPixelRect(centerX - headRadius, centerY - headRadius + 4, headRadius * 2, headRadius * 2 - 8, '#ffdd00');
                drawPixelRect(centerX - headRadius + 3, centerY - headRadius + 1, headRadius * 2 - 6, 3, '#ffdd00');
                drawPixelRect(centerX - headRadius + 3, centerY + headRadius - 4, headRadius * 2 - 6, 3, '#ffdd00');
                drawPixelRect(centerX - headRadius + 1, centerY - headRadius + 3, headRadius * 2 - 2, 1, '#ffdd00');
                drawPixelRect(centerX - headRadius + 1, centerY + headRadius - 4, headRadius * 2 - 2, 1, '#ffdd00');
                drawPixelRect(centerX - headRadius + 1, centerY - headRadius + 4, 1, headRadius * 2 - 8, '#ffdd00');
                drawPixelRect(centerX + headRadius - 2, centerY - headRadius + 4, 1, headRadius * 2 - 8, '#ffdd00');
                
                // Simple highlight on forehead
                drawPixelRect(centerX + 4, centerY - 8, 2, 1, '#ffffff');
                
                // Three white horns on top
                drawPixelRect(centerX - 10, centerY - headRadius - 4, 3, 6, '#ffffff');
                drawPixelRect(centerX - 1, centerY - headRadius - 6, 3, 8, '#ffffff');
                drawPixelRect(centerX + 7, centerY - headRadius - 4, 3, 6, '#ffffff');
                
                // MASSIVE 3D glasses
                drawPixelRect(centerX - 20, centerY - 12, 16, 16, '#ffffff');
                drawPixelRect(centerX + 4, centerY - 12, 16, 16, '#ffffff');
                
                // HUGE ELECTRIC BLUE lens (left)
                drawPixelRect(centerX - 18, centerY - 10, 12, 12, '#0044ff');
                drawPixelRect(centerX - 16, centerY - 8, 8, 8, '#0066ff');
                drawPixelRect(centerX - 14, centerY - 6, 4, 4, '#44aaff');
                
                // HUGE HOT PINK lens (right)
                drawPixelRect(centerX + 6, centerY - 10, 12, 12, '#ff0044');
                drawPixelRect(centerX + 8, centerY - 8, 8, 8, '#ff0066');
                drawPixelRect(centerX + 10, centerY - 6, 4, 4, '#ff44aa');
                
                // Glasses bridge
                drawPixelRect(centerX - 4, centerY - 4, 8, 4, '#ffffff');
                
                // Smile
                drawPixelRect(centerX - 4, centerY + 10, 8, 1, '#000000');
                
                // ELF EARS
                drawPixelRect(centerX - headRadius - 3, centerY - 2, 4, 8, '#ffdd00');
                drawPixelRect(centerX - headRadius - 5, centerY - 4, 3, 6, '#ffdd00');
                drawPixelRect(centerX - headRadius - 6, centerY - 2, 2, 2, '#ffdd00');
                drawPixelRect(centerX - headRadius - 4, centerY + 4, 2, 2, '#888888');
                drawPixelRect(centerX - headRadius - 3, centerY + 4, 1, 1, '#ffffff');
                
                drawPixelRect(centerX + headRadius - 1, centerY - 2, 4, 8, '#ffdd00');
                drawPixelRect(centerX + headRadius + 2, centerY - 4, 3, 6, '#ffdd00');
                drawPixelRect(centerX + headRadius + 4, centerY - 2, 2, 2, '#ffdd00');
            }

            function createInvaders() {
                invaders = [];
                const colors = ['#ff00ff', '#00ffff', '#ffff00', '#ff6600', '#00ff00'];
                const cols = Math.min(10, Math.floor(gameState.canvasWidth / 60));
                const spacing = gameState.canvasWidth / (cols + 1);
                
                for (let row = 0; row < 5; row++) {
                    for (let col = 0; col < cols; col++) {
                        invaders.push({
                            x: (col + 1) * spacing - 20,
                            y: row * 50 + 50,
                            width: 40,
                            height: 30,
                            color: colors[row],
                            alive: true,
                            type: row
                        });
                    }
                }
            }

            function drawInvader(invader) {
                if (!invader.alive) return;
                
                switch(invader.type) {
                    case 0: // Green alien with purple beanie
                        drawPixelRect(invader.x + 8, invader.y + 8, 24, 20, '#66ff66');
                        drawPixelRect(invader.x + 6, invader.y, 28, 12, '#aa44aa');
                        drawPixelRect(invader.x + 4, invader.y + 20, 32, 10, '#444444');
                        drawPixelRect(invader.x + 8, invader.y + 10, 24, 8, '#ffffff');
                        drawPixelRect(invader.x + 10, invader.y + 12, 8, 4, '#222222');
                        drawPixelRect(invader.x + 22, invader.y + 12, 8, 4, '#222222');
                        drawPixelRect(invader.x + 18, invader.y + 20, 4, 2, '#333333');
                        break;
                        
                    case 1: // Cyan alien with goggles and flame
                        drawPixelRect(invader.x + 8, invader.y + 8, 24, 20, '#44dddd');
                        drawPixelRect(invader.x + 6, invader.y + 10, 28, 10, '#333333');
                        drawPixelRect(invader.x + 12, invader.y + 12, 4, 4, '#ff2222');
                        drawPixelRect(invader.x + 24, invader.y + 12, 4, 4, '#ff2222');
                        drawPixelRect(invader.x + 18, invader.y, 4, 8, '#ffff44');
                        drawPixelRect(invader.x + 16, invader.y + 2, 8, 4, '#ffaa22');
                        drawPixelRect(invader.x + 4, invader.y + 22, 32, 8, '#eeeeee');
                        drawPixelRect(invader.x + 16, invader.y + 20, 8, 4, '#ffffff');
                        break;
                        
                    case 2: // Brown alien with 3D glasses
                        drawPixelRect(invader.x + 8, invader.y + 8, 24, 20, '#cc8844');
                        drawPixelRect(invader.x + 6, invader.y, 28, 12, '#ff6622');
                        drawPixelRect(invader.x + 6, invader.y + 12, 28, 6, '#222222');
                        drawPixelRect(invader.x + 8, invader.y + 13, 10, 4, '#2266ff');
                        drawPixelRect(invader.x + 22, invader.y + 13, 10, 4, '#ff2266');
                        drawPixelRect(invader.x + 15, invader.y + 20, 2, 4, '#ff0066');
                        drawPixelRect(invader.x + 17, invader.y + 22, 2, 4, '#ffff00');
                        drawPixelRect(invader.x + 19, invader.y + 24, 2, 4, '#00ff66');
                        drawPixelRect(invader.x + 4, invader.y + 24, 32, 6, '#ffffff');
                        break;
                        
                    case 3: // Light green alien with 3D glasses
                        drawPixelRect(invader.x + 8, invader.y + 8, 24, 20, '#88ff88');
                        drawPixelRect(invader.x + 6, invader.y, 28, 12, '#44aa44');
                        drawPixelRect(invader.x + 6, invader.y + 12, 28, 6, '#ffffff');
                        drawPixelRect(invader.x + 8, invader.y + 13, 10, 4, '#3366ff');
                        drawPixelRect(invader.x + 22, invader.y + 13, 10, 4, '#ff3366');
                        drawPixelRect(invader.x + 16, invader.y + 20, 8, 2, '#ff4488');
                        drawPixelRect(invader.x + 4, invader.y + 24, 32, 6, '#ff88cc');
                        break;
                        
                    case 4: // Blue alien with bubble gum
                        drawPixelRect(invader.x + 8, invader.y + 8, 24, 18, '#66aaff');
                        drawPixelRect(invader.x + 6, invader.y, 28, 12, '#888888');
                        drawPixelRect(invader.x + 10, invader.y + 10, 8, 8, '#ffffff');
                        drawPixelRect(invader.x + 22, invader.y + 10, 8, 8, '#ffffff');
                        drawPixelRect(invader.x + 13, invader.y + 13, 2, 2, '#000000');
                        drawPixelRect(invader.x + 25, invader.y + 13, 2, 2, '#000000');
                        drawPixelRect(invader.x + 12, invader.y + 12, 1, 1, '#ffffff');
                        drawPixelRect(invader.x + 24, invader.y + 12, 1, 1, '#ffffff');
                        drawPixelRect(invader.x + 14, invader.y + 20, 12, 6, '#ff99cc');
                        drawPixelRect(invader.x + 16, invader.y + 18, 8, 4, '#ffaadd');
                        drawPixelRect(invader.x + 4, invader.y + 26, 32, 4, '#ff88cc');
                        break;
                }
            }

            function createBullet(x, y, direction) {
                return {
                    x: x,
                    y: y,
                    width: 6,
                    height: 12,
                    speed: direction > 0 ? 5 : -10,
                    color: direction > 0 ? '#ff0066' : '#00ffff'
                };
            }

            function drawBullet(bullet) {
                drawPixelRect(bullet.x, bullet.y, bullet.width, bullet.height, bullet.color);
                ctx.shadowColor = bullet.color;
                ctx.shadowBlur = 15;
                drawPixelRect(bullet.x, bullet.y, bullet.width, bullet.height, bullet.color);
                ctx.shadowBlur = 0;
                const coreColor = bullet.color === '#ff0066' ? '#ff99bb' : '#66ffff';
                drawPixelRect(bullet.x + 1, bullet.y + 2, bullet.width - 2, bullet.height - 4, coreColor);
            }

            function createParticle(x, y, color) {
                return {
                    x: x + Math.random() * 20 - 10,
                    y: y + Math.random() * 20 - 10,
                    vx: Math.random() * 6 - 3,
                    vy: Math.random() * 6 - 3,
                    life: 30,
                    color: color,
                    size: Math.random() * 4 + 2
                };
            }

            function updateParticles() {
                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;
                    
                    if (p.life <= 0) {
                        particles.splice(i, 1);
                    } else {
                        ctx.globalAlpha = p.life / 30;
                        drawPixelRect(p.x, p.y, p.size, p.size, p.color);
                        ctx.globalAlpha = 1;
                    }
                }
            }

            function checkCollision(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            }

            function updateLeaderboard() {
                const list = document.getElementById('leaderboardList');
                const gameOverList = document.getElementById('gameOverLeaderboard');
                
                const content = leaderboard.slice(0, 5).map((entry, index) => {
                    const isCurrentScore = entry.score === gameState.score && entry.name === (document.getElementById('playerName').value || 'Anonymous');
                    const highlight = isCurrentScore ? 'style="background: rgba(255, 0, 255, 0.3); color: #ffff00;"' : '';
                    return `<div class="leaderboard-entry" ${highlight}>
                        <span>${index + 1}. ${entry.name}</span>
                        <span>${entry.score}</span>
                    </div>`;
                }).join('');
                
                if (list) list.innerHTML = content;
                if (gameOverList) gameOverList.innerHTML = content;
            }

            function checkHighScore() {
                document.getElementById('finalScore').textContent = gameState.score;
                updateLeaderboard();
                
                if (leaderboard.length < 5 || gameState.score > leaderboard[leaderboard.length - 1].score) {
                    document.getElementById('nameInput').style.display = 'block';
                } else {
                    document.getElementById('gameOver').style.display = 'block';
                }
            }

            window.submitScore = function() {
                const name = document.getElementById('playerName').value || 'Anonymous';
                leaderboard.push({ name: name, score: gameState.score });
                leaderboard.sort((a, b) => b.score - a.score);
                leaderboard = leaderboard.slice(0, 5);
                
                try {
                    localStorage.setItem('mystclInvadersLeaderboard', JSON.stringify(leaderboard));
                } catch (e) {}
                updateLeaderboard();
                
                document.getElementById('nameInput').style.display = 'none';
                document.getElementById('gameOver').style.display = 'block';
            }

            window.skipScore = function() {
                document.getElementById('nameInput').style.display = 'none';
                updateLeaderboard();
                document.getElementById('gameOver').style.display = 'block';
            }

            // Mobile controls
            let mobileControls = {
                moveLeft: false,
                moveRight: false,
                shoot: false,
                joystickActive: false
            };

            function setupMobileControls() {
                if (isMobile()) {
                    document.getElementById('mobileControls').style.display = 'block';
                    document.getElementById('desktopControls').style.display = 'none';
                    document.getElementById('mobileControlsUI').style.display = 'block';
                    
                    setupJoystick();
                    setupFireButton();
                } else {
                    document.getElementById('mobileControlsUI').style.display = 'none';
                }
            }

            function setupJoystick() {
                const stick = document.getElementById('joystickStick');
                const container = document.getElementById('joystick');
                let isDragging = false;
                
                // Touch events for mobile
                stick.ontouchstart = function(e) {
                    e.preventDefault();
                    isDragging = true;
                    mobileControls.joystickActive = true;
                };
                
                stick.ontouchmove = function(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    
                    const touch = e.touches[0];
                    const containerRect = container.getBoundingClientRect();
                    const stickRadius = 25; // Half of stick width (50px)
                    
                    // Calculate position relative to container
                    let x = touch.clientX - containerRect.left - stickRadius;
                    
                    // Constrain to container bounds
                    x = Math.max(0, Math.min(containerRect.width - 50, x));
                    
                    // Update stick position
                    stick.style.left = x + 'px';
                    stick.style.transform = 'translateY(-50%)';
                    
                    // Calculate movement based on position
                    const center = containerRect.width / 2 - stickRadius;
                    const threshold = 30;
                    
                    mobileControls.moveLeft = x < center - threshold;
                    mobileControls.moveRight = x > center + threshold;
                };
                
                stick.ontouchend = function(e) {
                    e.preventDefault();
                    isDragging = false;
                    mobileControls.joystickActive = false;
                    mobileControls.moveLeft = false;
                    mobileControls.moveRight = false;
                    
                    // Reset to center
                    stick.style.left = '50%';
                    stick.style.transform = 'translate(-50%, -50%)';
                };
                
                // Prevent context menu on long press
                stick.oncontextmenu = function(e) {
                    e.preventDefault();
                    return false;
                };
            }

            function setupFireButton() {
                const fireButton = document.getElementById('fireButton');
                
                fireButton.ontouchstart = function(e) {
                    e.preventDefault();
                    mobileControls.shoot = true;
                };
                
                fireButton.ontouchend = function(e) {
                    e.preventDefault();
                    mobileControls.shoot = false;
                };
                
                fireButton.ontouchcancel = function(e) {
                    e.preventDefault();
                    mobileControls.shoot = false;
                };
                
                // Prevent context menu
                fireButton.oncontextmenu = function(e) {
                    e.preventDefault();
                    return false;
                };
            }

            function updateGame() {
                if (gameState.gameOver) return;

                // Move player
                if ((gameState.keys['ArrowLeft'] || mobileControls.moveLeft) && player.x > 0) {
                    player.x -= player.speed;
                }
                if ((gameState.keys['ArrowRight'] || mobileControls.moveRight) && player.x < gameState.canvasWidth - player.width) {
                    player.x += player.speed;
                }

                // Player shooting
                if ((gameState.keys[' '] || mobileControls.shoot) && Date.now() - gameState.lastShot > 200) {
                    bullets.push(createBullet(player.x + player.width/2, player.y + player.height/2 - 20, -1));
                    gameState.lastShot = Date.now();
                }

                // Update bullets
                for (let i = bullets.length - 1; i >= 0; i--) {
                    bullets[i].y += bullets[i].speed;
                    if (bullets[i].y < 0) bullets.splice(i, 1);
                }

                for (let i = invaderBullets.length - 1; i >= 0; i--) {
                    invaderBullets[i].y += invaderBullets[i].speed;
                    if (invaderBullets[i].y > gameState.canvasHeight) invaderBullets.splice(i, 1);
                }

                // Move invaders
                let direction = Math.sin(Date.now() * 0.001) > 0 ? 1 : -1;
                const currentSpeed = gameState.invaderSpeed * gameState.level * 0.1 + gameState.invaderSpeed;
                
                invaders.forEach(invader => {
                    if (invader.alive) {
                        invader.x += direction * currentSpeed;
                        invader.y += 0.1 * gameState.level * 0.2;
                        
                        if (Math.random() < 0.0005 + (gameState.level * 0.0002)) {
                            invaderBullets.push(createBullet(invader.x + invader.width/2, invader.y + invader.height, 1));
                        }
                    }
                });

                // Collisions
                for (let i = bullets.length - 1; i >= 0; i--) {
                    for (let j = shields.length - 1; j >= 0; j--) {
                        if (shields[j].alive && checkCollision(bullets[i], shields[j])) {
                            for (let k = 0; k < 3; k++) {
                                particles.push(createParticle(shields[j].x, shields[j].y, shields[j].color));
                            }
                            shields[j].alive = false;
                            bullets.splice(i, 1);
                            break;
                        }
                    }
                }

                for (let i = invaderBullets.length - 1; i >= 0; i--) {
                    for (let j = shields.length - 1; j >= 0; j--) {
                        if (shields[j].alive && checkCollision(invaderBullets[i], shields[j])) {
                            for (let k = 0; k < 3; k++) {
                                particles.push(createParticle(shields[j].x, shields[j].y, shields[j].color));
                            }
                            shields[j].alive = false;
                            invaderBullets.splice(i, 1);
                            break;
                        }
                    }
                }

                for (let i = bullets.length - 1; i >= 0; i--) {
                    for (let j = invaders.length - 1; j >= 0; j--) {
                        if (invaders[j].alive && checkCollision(bullets[i], invaders[j])) {
                            for (let k = 0; k < 8; k++) {
                                particles.push(createParticle(invaders[j].x, invaders[j].y, invaders[j].color));
                            }
                            invaders[j].alive = false;
                            bullets.splice(i, 1);
                            gameState.score += (5 - invaders[j].type) * 10;
                            break;
                        }
                    }
                }

                for (let i = invaderBullets.length - 1; i >= 0; i--) {
                    if (checkCollision(invaderBullets[i], player)) {
                        for (let k = 0; k < 12; k++) {
                            particles.push(createParticle(player.x, player.y, '#ff0066'));
                        }
                        invaderBullets.splice(i, 1);
                        gameState.lives--;
                        
                        if (gameState.lives <= 0) {
                            gameState.gameOver = true;
                            checkHighScore();
                        }
                        break;
                    }
                }

                if (invaders.every(invader => !invader.alive)) {
                    gameState.level++;
                    gameState.shieldScale = Math.max(0.3, gameState.shieldScale - 0.1);
                    createInvaders();
                    if (gameState.level % 3 === 1) {
                        createShields();
                    }
                }

                // Update UI
                document.getElementById('score').textContent = gameState.score;
                document.getElementById('lives').textContent = gameState.lives;
                document.getElementById('level').textContent = gameState.level;
            }

            function draw() {
                ctx.clearRect(0, 0, gameState.canvasWidth, gameState.canvasHeight);
                drawShields();
                drawPlayer();
                invaders.forEach(drawInvader);
                bullets.forEach(drawBullet);
                invaderBullets.forEach(drawBullet);
                updateParticles();
            }

            function gameLoop() {
                updateGame();
                draw();
                requestAnimationFrame(gameLoop);
            }

            window.resetGame = function() {
                gameState = {
                    score: 0,
                    lives: 3,
                    level: 1,
                    gameOver: false,
                    keys: {},
                    lastShot: 0,
                    invaderSpeed: 0.5,
                    shieldScale: 1.0,
                    canvasWidth: gameState.canvasWidth,
                    canvasHeight: gameState.canvasHeight
                };
                
                scalePlayerPosition();
                bullets = [];
                invaderBullets = [];
                particles = [];
                createInvaders();
                createShields();
                document.getElementById('gameOver').style.display = 'none';
                document.getElementById('nameInput').style.display = 'none';
                document.getElementById('playerName').value = '';
            }

            // Event listeners
            document.addEventListener('keydown', (e) => {
                gameState.keys[e.key] = true;
                if (e.key === 'r' || e.key === 'R') {
                    window.resetGame();
                }
            });

            document.addEventListener('keyup', (e) => {
                gameState.keys[e.key] = false;
            });

            // Initialize
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            setupMobileControls();
            scalePlayerPosition();
            createInvaders();
            createShields();
            updateLeaderboard();
            gameLoop();
        }
    </script>
</body>
</html>